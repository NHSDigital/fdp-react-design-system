name: SPC Validate

on:
  pull_request:
    paths:
      - 'packages/nhs-fdp-spc/**'
      - 'scripts/spc-*'
      - 'config/vite.spc.*'
      - 'package.json'
  push:
    branches: [ master ]
    paths:
      - 'packages/nhs-fdp-spc/**'
      - 'scripts/spc-*'
      - 'config/vite.spc.*'
      - 'package.json'

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
            node-version: 22
            cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Build SPC
        run: npm run build:spc
      - name: Validate SPC package
        run: npm run spc:validate
      - name: Export surface check
        run: npm run spc:exports:check || (echo '::error ::Export surface check failed' && exit 1)
      - name: Adoption metric (summary only)
        run: |
          npm run spc:adoption > adoption.txt || true
          echo '### SPC Adoption Metric' >> $GITHUB_STEP_SUMMARY
          sed 's/^/`/;s/$/`/' adoption.txt >> $GITHUB_STEP_SUMMARY || true
      - name: Bundle sizes summary
        run: |
          echo '### SPC Bundle Sizes (gzip approx)' >> $GITHUB_STEP_SUMMARY
          if [ -f packages/nhs-fdp-spc/dist/index.esm.js ]; then
            npx gzip-size-cli packages/nhs-fdp-spc/dist/index.esm.js >> $GITHUB_STEP_SUMMARY || true
          fi
          if [ -f packages/nhs-fdp-spc/dist/spc.css ]; then
            npx gzip-size-cli packages/nhs-fdp-spc/dist/spc.css >> $GITHUB_STEP_SUMMARY || true
          fi
