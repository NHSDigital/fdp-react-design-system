.mermaid-diagram {
  --_mm-bg: var(--nhs-fdp-color-grey-6, nhs.$nhs-fdp-color-grey-6);
  --_mm-border: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4);
  --_mm-text: var(--nhs-fdp-color-text, nhs.$nhs-fdp-color-primary-black);
  --_mm-accent: var(
  	--nhs-fdp-color-primary-blue,
  	nhs.$nhs-fdp-color-primary-blue
  );
  --_mm-accent-alt: var(
  	--nhs-fdp-color-data-viz-spc-improvement,
  	nhs.$nhs-fdp-color-data-viz-spc-improvement
  );
  --_mm-warn: var(
  	--nhs-fdp-color-data-viz-spc-concern,
  	nhs.$nhs-fdp-color-data-viz-spc-concern
  );
  --_mm-radius: 6px;
  background: var(--_mm-bg);
  border: 1px solid var(--_mm-border);
  border-radius: var(--_mm-radius);
  padding: 24px;
  overflow-x: auto;
  font-family: Frutiger W01, Arial, sans-serif;
  line-height: 1.3;
  position: relative;
  /* Scroll hint (fade) */
  mask-image: linear-gradient(to right, transparent 0, #000 24px, #000 calc(100% - 24px), transparent 100%);
}

.mermaid-error {
  background: var(--nhs-fdp-color-data-viz-spc-concern, #e46c0a);
  color: #fff;
  padding: 16px;
  border-radius: 4px;
  font-size: 14px;
  overflow-x: auto;
}

/* Core mermaid-generated element overrides */
.mermaid-diagram svg {
  width: 100%;
  height: auto;
}

/* Base node shapes (extra specificity + !important to beat Mermaid injected <style>) */
.mermaid-diagram svg .node rect,
.mermaid-diagram svg .node polygon,
.mermaid-diagram svg .node circle,
.mermaid-diagram svg .node ellipse {
  fill: var(--nhs-fdp-color-primary-blue, #005eb8) !important;
  stroke: var(--_mm-border) !important;
  stroke-width: 1px !important;
  rx: var(--_mm-radius);
  ry: var(--_mm-radius);
}

.mermaid-diagram svg .node text {
  fill: var(--_mm-text) !important;
  font-size: 13px;
  font-family: Frutiger W01, Arial, sans-serif !important;
}

/* Decision nodes (rhombus) */
.mermaid-diagram .node .label foreignObject > div {
  padding: 2px 4px;
}

/* Mermaid generated structure overrides (hierarchical nesting) */
.mermaid-diagram {
  font-family: "Frutiger W01", Arial, sans-serif;
  /* Nodes */
}
.mermaid-diagram svg {
  width: 100%;
  height: auto;
}
.mermaid-diagram span.nodeLabel {
  font-size: 14px !important;
  color: var(--nhs-fdp-color-primary-white, #ffffff) !important;
  font-family: "Frutiger W01", Arial, sans-serif;
}
.mermaid-diagram svg {
  /* Edges */
}
.mermaid-diagram svg .node {
  /* Base shapes (specificity via svg .node + !important) */
  /* Accent nodes (start/end/terminal) */
  /* Highlight key action outputs */
}
.mermaid-diagram svg .node rect,
.mermaid-diagram svg .node polygon,
.mermaid-diagram svg .node circle,
.mermaid-diagram svg .node ellipse {
  fill: var(--nhs-fdp-color-primary-blue, #005eb8) !important;
  stroke: var(--_mm-border) !important;
  stroke-width: 1px !important;
  rx: var(--_mm-radius);
  ry: var(--_mm-radius);
}
.mermaid-diagram svg .node text {
  /* Use standard diagram text colour; 12px matches Mermaid default to avoid bbox truncation */
  fill: var(--nhs-fdp-color-primary-white, #ffffff) !important;
  font-size: 12px;
  font-family: "Frutiger W01", Arial, sans-serif !important;
}
.mermaid-diagram svg .node[id^=A] rect,
.mermaid-diagram svg .node[id^=A] polygon,
.mermaid-diagram svg .node[id^=A] circle,
.mermaid-diagram svg .node[id^=A] ellipse, .mermaid-diagram svg .node[id^=Z] rect,
.mermaid-diagram svg .node[id^=Z] polygon,
.mermaid-diagram svg .node[id^=Z] circle,
.mermaid-diagram svg .node[id^=Z] ellipse, .mermaid-diagram svg .node[id^=X] rect,
.mermaid-diagram svg .node[id^=X] polygon,
.mermaid-diagram svg .node[id^=X] circle,
.mermaid-diagram svg .node[id^=X] ellipse {
  fill: var(--_mm-accent-alt) !important;
  stroke: var(--_mm-accent) !important;
}
.mermaid-diagram svg .node[id^=A] text, .mermaid-diagram svg .node[id^=Z] text, .mermaid-diagram svg .node[id^=X] text {
  font-weight: 600 !important;
}
.mermaid-diagram svg .node[id^=H] rect,
.mermaid-diagram svg .node[id^=H] polygon,
.mermaid-diagram svg .node[id^=H] circle,
.mermaid-diagram svg .node[id^=H] ellipse, .mermaid-diagram svg .node[id^=N] rect,
.mermaid-diagram svg .node[id^=N] polygon,
.mermaid-diagram svg .node[id^=N] circle,
.mermaid-diagram svg .node[id^=N] ellipse {
  fill: var(--_mm-accent) !important;
  stroke: var(--_mm-accent-alt) !important;
}
.mermaid-diagram svg .node[id^=H] text, .mermaid-diagram svg .node[id^=N] text {
  fill: #fff !important;
  font-weight: 600 !important;
}
.mermaid-diagram svg .node .label {
  /* Decision emphasis for threshold-related content */
}
.mermaid-diagram svg .node .label foreignObject > div {
  padding: 2px 4px;
}
.mermaid-diagram svg .node .label:has(div:contains("threshold")) rect, .mermaid-diagram svg .node .label:has(span:contains("threshold")) rect {
  stroke: var(--_mm-warn);
}
.mermaid-diagram svg .edgePath path.path {
  stroke: var(--_mm-border) !important;
  stroke-width: 1.2px !important;
}
.mermaid-diagram svg .edgeLabel {
  background-color: #ffffff !important; /* optional background */
  margin: 0 4px;
  padding: 0 2px;
  overflow: visible; /* allow expansion */
  font-size: 11px;
}
.mermaid-diagram svg .edgeLabel text {
  fill: var(--_mm-text) !important;
  white-space: nowrap;
  font-size: 12px;
  font-weight: bold;
}

/* Dark mode */
.theme-dark .mermaid-diagram {
  --_mm-bg: var(--nhs-fdp-color-grey-1, nhs.$nhs-fdp-color-grey-1);
  --_mm-border: var(--nhs-fdp-color-grey-3, nhs.$nhs-fdp-color-grey-3);
  --_mm-text: var(--nhs-fdp-color-text-on-dark, #fff);
}