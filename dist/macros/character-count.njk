{# CharacterCount component macro (parity with React CharacterCount) #}
{% macro characterCount(params) %}
  {# Determine counting mode and limit #}
  {% set limit = params.maxLength if params.maxLength is defined else params.maxWords %}
  {% set isWords = params.maxWords is defined %}
  {% set unit = 'word' if isWords else 'character' %}
  {% set unitPlural = 'words' if isWords else 'characters' %}
  {# React server render leaves textarea content empty even when defaultValue provided (value attribute not serialised); parity: suppress content. #}
  {% set initialValue = '' %}
  {# Count words manually (Nunjucks lacks regex split). Collapse whitespace first. #}
  {% if isWords %}
    {% set trimmed = initialValue | trim %}
    {% if trimmed == '' %}
      {% set count = 0 %}
    {% else %}
      {% set normalised = trimmed.replace('\n', ' ') %}
      {% set normalised = normalised.replace('  ', ' ') %}
      {% set parts = normalised.split(' ') %}
      {% set count = parts | length %}
    {% endif %}
  {% else %}
    {% set count = initialValue | length %}
  {% endif %}
  {% set remaining = limit - count %}
  {% set threshold = params.threshold or 75 %}
  {% set thresholdCount = (limit * (threshold / 100)) | round(0, 'floor') %}
  {% set showCount = count >= thresholdCount or count > limit %}
  {% set isOver = count > limit %}

  {% set wrapperClasses = 'nhsuk-character-count' %}{% if params.className %}{% set wrapperClasses = wrapperClasses + ' ' + params.className %}{% endif %}
  {% set textareaClasses = 'nhsuk-js-character-count' %}{% if isOver %}{% set textareaClasses = textareaClasses + ' nhsuk-textarea--error' %}{% endif %}
  {% set messageClasses = 'nhsuk-character-count__message' %}{% if not showCount %}{% set messageClasses = messageClasses + ' nhsuk-character-count__message--disabled' %}{% endif %}{% if isOver %}{% set messageClasses = messageClasses + ' nhsuk-error-message' %}{% endif %}

  <div
    class="{{ wrapperClasses }}"
    data-module="nhsuk-character-count"
    {% if params.maxLength is defined %}data-maxlength="{{ params.maxLength }}"{% endif %}
    {% if params.maxWords is defined %}data-maxwords="{{ params.maxWords }}"{% endif %}
    data-threshold="{{ threshold }}"
    data-testid="character-count"
  >
    <textarea
      class="nhsuk-textarea {{ textareaClasses }}"
      id="{{ params.id }}"
      name="{{ params.name }}"
      rows="{{ params.rows or 5 }}"
      aria-describedby="{{ params.id }}-info"
      wrap="soft"
    ></textarea>
    <div
      class="nhsuk-hint {{ messageClasses }}"
      id="{{ params.id }}-info"
      role="status"
      aria-live="polite"
    >
      {# Message mirrors React generateCountMessage initial state #}
  You can enter up to {{ limit }} {{ limit == 1 and unit or unitPlural }}
    </div>
  </div>
{% endmacro %}
