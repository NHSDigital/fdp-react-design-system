// Import generated design token bundle (same pattern as Header.scss but deeper path depth)
@use "../../../../../../packages/nhs-fdp/dist/scss/tokens" as nhs;
/*
 * SPCChart specific styling extracted from global DataVisualisation.scss
 * Colours now sourced from SPC design tokens (color.data-viz.spc.*) instead of hardcoded hex values.
 *  - Improvement (special cause improving): var(--nhs-fdp-color-data-viz-spc-improvement)
 *  - Concern / deteriorating (special cause deteriorating): var(--nhs-fdp-color-data-viz-spc-concern)
 *  - Common cause (no special cause): var(--nhs-fdp-color-data-viz-spc-common-cause) (default point fill)
 *  - Special cause (no judgement): var(--nhs-fdp-color-data-viz-spc-no-judgement)
 * Stroke colours also tokenised (spc-stroke-*).
 */

// Use design token SCSS variables (prefixed $nhs-fdp-) with CSS custom property fallbacks
// Hierarchical (nested) BEM structure for clarity.

.fdp-spc {
	&__cl {
		stroke: var(--nhs-fdp-color-grey-1, nhs.$nhs-fdp-color-grey-1);
		stroke-width: 1.25;
	}
	&__limit {
		stroke: var(--nhs-fdp-color-grey-2, nhs.$nhs-fdp-color-grey-2);
		stroke-width: 1;
		stroke-dasharray: 4 4;
	}
	&__target {
		stroke: var(--nhs-fdp-color-data-viz-spc-target, nhs.$nhs-fdp-color-primary-blue);
		stroke-width: 2;
		stroke-dasharray: 6 4;
	}
	&__target-label {
		fill: var(--nhs-fdp-color-data-viz-spc-target, nhs.$nhs-fdp-color-primary-blue);
		font-weight: 600;
		paint-order: stroke;
		stroke: #fff;
		stroke-width: 3px;
		stroke-linejoin: round;
	}
	&__zone {
		stroke: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4);
		stroke-width: 0.75;
	}

	// Data points (circles)
	&__point {
		/* Default SPC data point fill: use neutral Grey 3 instead of green */
		fill: var(--nhs-fdp-color-grey-3, nhs.$nhs-fdp-color-grey-3);
		stroke: var(
			--nhs-fdp-color-data-viz-spc-stroke-common-cause,
			nhs.$nhs-fdp-color-data-viz-spc-stroke-common-cause
		);
		stroke-width: 1;
		transition: fill 120ms ease, stroke 120ms ease;

		&--sc-concern {
			fill: var(
				--nhs-fdp-color-data-viz-spc-concern,
				nhs.$nhs-fdp-color-data-viz-spc-concern
			);
			stroke: var(
				--nhs-fdp-color-data-viz-spc-stroke-concern,
				nhs.$nhs-fdp-color-data-viz-spc-stroke-concern
			);
			stroke-width: 1.5;

			&:hover,
			&:focus,
			&:focus-visible {
				stroke: var(--nhs-fdp-color-primary-yellow, nhs.$nhs-fdp-color-primary-yellow);
				stroke-width: 2.5;
				outline: none;
			}
		}
		&--sc-improvement {
			fill: var(
				--nhs-fdp-color-data-viz-spc-improvement,
				nhs.$nhs-fdp-color-data-viz-spc-improvement
			);
			stroke: var(
				--nhs-fdp-color-data-viz-spc-stroke-improvement,
				nhs.$nhs-fdp-color-data-viz-spc-stroke-improvement
			);
			stroke-width: 1.25;

			&:hover,
			&:focus,
			&:focus-visible {
				stroke: var(--nhs-fdp-color-primary-yellow, nhs.$nhs-fdp-color-primary-yellow);
				stroke-width: 2.5;
				outline: none;
			}
		}
		&--sc-no-judgement {
			fill: var(
				--nhs-fdp-color-data-viz-spc-no-judgement,
				nhs.$nhs-fdp-color-data-viz-spc-no-judgement
			);
			stroke: var(
				--nhs-fdp-color-data-viz-spc-stroke-no-judgement,
				nhs.$nhs-fdp-color-data-viz-spc-stroke-no-judgement
			);
			stroke-width: 1.25;

			&:hover,
			&:focus,
			&:focus-visible {
				stroke: var(--nhs-fdp-color-primary-yellow, nhs.$nhs-fdp-color-primary-yellow);
				stroke-width: 2.5;
				outline: none;
			}
		}

		&:hover {
			fill: nhs.$nhs-fdp-color-primary-yellow;
		}

		&:focus {
			outline-color: nhs.$nhs-fdp-color-primary-black;
		}
	}

	// Icon base + modifiers
	&__icon {
		font-size: 10px;
		font-weight: 600;
		fill: #000;
		pointer-events: none;
		&--concern {
			fill: var(
				--nhs-fdp-color-data-viz-spc-concern,
				nhs.$nhs-fdp-color-data-viz-spc-concern
			);
		}
		&--improvement {
			fill: var(
				--nhs-fdp-color-data-viz-spc-improvement,
				nhs.$nhs-fdp-color-data-viz-spc-improvement
			);
		}
		&--no-judgement {
			fill: var(
				--nhs-fdp-color-data-viz-spc-no-judgement,
				nhs.$nhs-fdp-color-data-viz-spc-no-judgement
			);
		}
	}
}

// Warnings / diagnostics panel
.fdp-spc-chart__warnings {
	border: 1px solid var(--nhs-fdp-color-border, #d8dde0);
	border-radius: 4px;
	padding: 8px 12px;
	margin-bottom: 12px;
	background: var(--nhs-fdp-color-surface-muted, #f8f8f8);
	/* Inherit brand-aware font via CSS variables; fall back to chart font variable */
	font-family: var(--nhs-font-family-base, var(--fdp-chart-font-family));
}
.fdp-spc-chart__warnings-heading {
	font-size: 12px;
	margin-bottom: 0px;
	letter-spacing: 0.5px;
	font-weight: 600;
}
// .fdp-spc-chart__warnings-list { list-style: none; margin:0; padding:0; display:flex; flex-direction:column; gap:4px; } // legacy (pre-table)
// .fdp-spc-chart__warning-item { font-size:12px; line-height:1.45; display:flex; gap:8px; align-items:flex-start; } // legacy

// .fdp-spc-chart__warning-cell--severity { width:90px; }
// .fdp-spc-chart__warning-cell--category { width:120px; }
// .fdp-spc-chart__warning-cell--code { width:160px; }
// .fdp-spc-chart__warning-cell--message { width:auto; }
// .fdp-spc-chart__warning-empty { color:#666; font-style:italic; }
// .fdp-spc-chart__warning-message { display:flex; flex-direction:column; gap:4px; }
// .fdp-spc-chart__warning-badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:12px; font-weight:600; text-transform:lowercase; background:#d9dde0; color:#000; }
// .fdp-spc-chart__warning-badge--warning { background: var(--nhs-fdp-color-status-warning-bg, #ffbf47); color:#000; }
// .fdp-spc-chart__warning-badge--error { background: var(--nhs-fdp-color-status-error, #d5281b); color:#fff; }
// .fdp-spc-chart__warning-code { font-size:11px; }
// .fdp-spc-chart__warning-context { margin-top:2px; }
// .fdp-spc-chart__warning-context summary { cursor:pointer; font-size:11px; }
// .fdp-spc-chart__warning-context pre { margin:0; font-size:10px; background:#f3f3f3; padding:4px; border-radius:4px; max-width:100%; overflow:auto; }

// Tooltip namespace (hierarchical). Root: .fdp-spc-tooltip-portal
.fdp-spc-tooltip-portal {
	background: var(--nhs-fdp-color-data-viz-tooltip-bg, #0b0c0c);
	color: var(--nhs-fdp-color-text-on-dark, #ffffff);
	border: 1px solid var(--nhs-fdp-color-border-dark, #3d444a);
	box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
	backdrop-filter: var(--nhs-fdp-backdrop-blur, none);
	opacity: 0;
	transform: translateY(-2px);
	transition:
		opacity 120ms ease-out,
		transform 120ms ease-out;
	border-radius: 6px;
	/* Tooltip should use the same brand-aware stack as charts */
	font-family: var(--nhs-font-family-base, var(--fdp-chart-font-family));
	font-size: 16px;
	line-height: 1.4;
	padding: 12px 16px 16px;
	max-width: 440px;
	box-sizing: border-box;

	&.is-visible {
		opacity: 0.96;
		transform: translateY(0);
	}
	// Elements (note: tooltip content uses separate block prefix fdp-spc-tooltip__*)
	.fdp-spc-tooltip__body {
		display: flex;
		flex-direction: column;
		/* Section spacing handled by global .fdp-spc-tooltip__section adjacency rule */
	}

	/* Stacked section blocks */
	.fdp-spc-tooltip__section + .fdp-spc-tooltip__section { margin-top: 14px; }
	.fdp-spc-tooltip__primary-line {
		font-weight: 600;
		letter-spacing: 0.2px;
	}
	.fdp-spc-tooltip__narrative {
		font-size: 12px;
		opacity: 0.88;
	}
	.fdp-spc-tooltip__section-label {
		margin-top: 4px;
		font-size: 11px;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		color: var(--nhs-fdp-color-text-on-dark, #ffffff);
	}
	.fdp-spc-tooltip__rules {
		margin-top: 2px;
	}
	/* Legacy rule list styles removed (replaced by tag layout) */

	// New tag layout for rules
	.fdp-spc-tooltip__rule-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 6px 8px; // horizontal (column) 8px, vertical (row) 6px
		margin-top: 6px;
		align-items: flex-start;

		/* Fallback for browsers without flex gap support (e.g. older Safari) */
		@supports not (gap: 1px) {
			margin-right: -8px; // compensate for right margin on children
			> * {
				margin: 0 8px 6px 0; // emulate gap: bottom + right margins
			}
			> *:last-child { margin-right: 0; }
		}

		/* Defensive: ensure vertical separation even if gap overridden elsewhere */
		> * { margin-bottom: 6px; }
		> *:nth-last-child(-n+3) { margin-bottom: 0; } // heuristic trim for final row
	}

	.fdp-spc-tooltip__badges {
		display: flex;
		flex-wrap: wrap;
		gap: 4px;
		margin-top: 2px;
	}
	.fdp-spc-badge {
		display: inline-flex;
		align-items: center;
		padding: 1px 6px 2px;
		border-radius: 10px;
		font-size: 11px;
		font-weight: 600;
		line-height: 1.2;
		letter-spacing: 0.3px;
	}
	.fdp-spc-badge--variation {
		&.is-improvement {
			background: var(
				--nhs-fdp-color-data-viz-spc-improvement,
				nhs.$nhs-fdp-color-data-viz-spc-improvement
			);
			color: #000;
		}
		&.is-concern {
			background: var(
				--nhs-fdp-color-data-viz-spc-concern,
				nhs.$nhs-fdp-color-data-viz-spc-concern
			);
			color: #fff;
		}
		&.is-common {
			background: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4);
			color: #000;
		}
	}
	.fdp-spc-badge--assurance {
		&.is-pass {
			background: var(--nhs-fdp-color-data-viz-spc-assurance-pass, #007f3b);
			color: #fff;
		}
		&.is-fail {
			background: var(--nhs-fdp-color-data-viz-spc-assurance-fail, #d5281b);
			color: #fff;
		}
	}
	.fdp-spc-badge--zone {
		background: var(--nhs-fdp-color-grey-5, nhs.$nhs-fdp-color-grey-5);
		color: #000;
	}

	@media (forced-colors: active) {
		border-color: CanvasText;
		.fdp-spc-badge {
			forced-color-adjust: none;
			border: 1px solid CanvasText;
			background: Canvas;
			color: CanvasText;
		}
	}
}

/* Make tag sizing and color modifiers available outside tooltip portal (e.g. Signals Inspector) */
.fdp-spc-tooltip__tag {
	font-size: 16px;
	line-height: 1.2;
}

// Tag overrides (using design-system Tag with neutral base then SPC colors)
.fdp-spc-tag {
	&--improvement { 
		background: var(--nhs-fdp-color-data-viz-spc-improvement, nhs.$nhs-fdp-color-data-viz-spc-improvement) !important; 
		color: #000 !important;
		border-color: var(--nhs-fdp-color-data-viz-spc-improvement, nhs.$nhs-fdp-color-data-viz-spc-improvement) !important;
	}
	&--concern { 
		background: var(--nhs-fdp-color-data-viz-spc-concern, nhs.$nhs-fdp-color-data-viz-spc-concern) !important; 
		color: #fff !important; 
		border-color: var(--nhs-fdp-color-data-viz-spc-concern, nhs.$nhs-fdp-color-data-viz-spc-concern) !important;
	}
	&--rule {
		/* Fallback to improvement token for rule tags (blue token not defined) */
		background: var(--nhs-fdp-color-data-viz-spc-improvement, nhs.$nhs-fdp-color-data-viz-spc-improvement) !important;
		color: #000 !important;
		border-color: var(--nhs-fdp-color-data-viz-spc-improvement, nhs.$nhs-fdp-color-data-viz-spc-improvement) !important;
		font-weight: 500 !important;
	}
	&--heuristic {
		/* Distinct purple tone for heuristics to visually separate from orthodox rule tags */
		background: var(--nhs-fdp-color-data-viz-spc-heuristic, #b366ff) !important;
		color: #000 !important;
		border-color: var(--nhs-fdp-color-data-viz-spc-heuristic, #b366ff) !important;
		font-weight: 500 !important;
		text-decoration: none;
	}
	/* Provenance taxonomy overlays (intentionally independent so they can refine backgrounds) */
	&--prov-orthodox { /* high statistical provenance */
		outline: 2px solid rgba(255,255,255,0.2);
	}
	&--prov-interpretive { /* medium provenance */
		background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent) !important;
	}
	&--prov-aggressive { /* caution: aggressive heuristic */
		box-shadow: 0 0 0 2px var(--nhs-fdp-color-data-viz-spc-concern, nhs.$nhs-fdp-color-data-viz-spc-concern) inset;
		position: relative;
	}
	&--prov-aggressive::after {
		content: '!';
		font-size: 11px;
		font-weight: 700;
		margin-left: 4px;
	}
	&--prov-unknown {
		background: var(--nhs-fdp-color-grey-5, nhs.$nhs-fdp-color-grey-5) !important;
		color: #000 !important;
	}
	&--common {
		background: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4) !important;
		color: #000 !important;
		border-color: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4) !important;
	}
	&--trend {
		/* Distinct purple for side-gated trend rules; uses heuristic token if available */
		background: var(--nhs-fdp-color-data-viz-spc-trend, var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092)) !important;
		color: #000 !important;
		border-color: var(--nhs-fdp-color-data-viz-spc-trend, var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092)) !important;
		font-weight: 600 !important;
	}
	&--no-judgement {
		background: var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092) !important;
		color: #fff!important;
		border-color: var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092) !important;
		font-weight: 600 !important;
	}
	/* Fallback override: if build pipeline still emits trend rule tags with --common instead of --trend,
	   target by data-rule-id so they render in purple. This is safe (higher specificity) and will be redundant
	   once all bundles use the dedicated --trend class consistently. */
	.fdp-spc-tooltip__rule-tags [data-rule-id="trend_inc"].fdp-spc-tag,
	.fdp-spc-tooltip__rule-tags [data-rule-id="trend_dec"].fdp-spc-tag {
		background: var(--nhs-fdp-color-data-viz-spc-trend, var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092)) !important;
		border-color: var(--nhs-fdp-color-data-viz-spc-trend, var(--nhs-fdp-color-data-viz-spc-no-judgement, #490092)) !important;
		color: #000 !important;
		font-weight: 600 !important;
	}
	&--zone {
		/* Match default tag sizing; reapply base tag padding */
		display: inline-flex !important;
		align-items: center !important;
		color: #000 !important;
		justify-content: center !important;
		padding: nhs.$nhs-fdp-spacing-1 nhs.$nhs-fdp-spacing-2 !important; // same as base .nhsuk-tag
		line-height: 1 !important; // use base line-height for vertical centering
		font-weight: 600 !important;
	}
}

/* Scoped override (Option B): only affect LineChart primitive points when rendered
   inside the SPC chart container (.fdp-spc-chart). Leaves other LineCharts untouched. */
.fdp-spc-chart {
	/* base & interactive states */
	circle.fdp-line-point {
		/* align LineSeries point defaults to neutral grey-3 inside SPC charts */
		fill: var(--nhs-fdp-color-grey-3, nhs.$nhs-fdp-color-grey-3) !important;
		stroke: var(--nhs-fdp-color-grey-5, nhs.$nhs-fdp-color-grey-5) !important;
		stroke-width: 1 !important;
	}
	circle.fdp-line-point:focus,
	circle.fdp-line-point:focus-visible,
	circle.fdp-line-point[tabindex]:hover {
		/* Keep same colour; optional subtle emphasis */
		fill: var(--nhs-fdp-color-data-viz-spc-common-cause, nhs.$nhs-fdp-color-data-viz-spc-common-cause) !important;
		stroke-width: 1.5 !important;
	}
}

rect:focus {
	outline: none;
}

// External source (citation) block rendered below chart
.fdp-spc-chart__source {
	margin-top: 4px;
	font-size:  nhs.$nhs-fdp-font-size-19-desktop;
	line-height: 1.4;
	color: var(--nhs-fdp-color-text-secondary, #555);
}
