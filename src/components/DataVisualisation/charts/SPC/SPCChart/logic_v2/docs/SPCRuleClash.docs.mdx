import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Data Visualisation/SPC/Guides/Rule Clash Guidance" />

# SPC Rule Clash Guidance

This guide documents examples where multiple special-cause rules may plausibly fire on closely related subsets of data – a "rule clash". It clarifies expected precedence and interpretation when simultaneous patterns (e.g. emerging shift plus high outlier) occur.

The datasets below replicate the five illustrative images from the legacy primaryField reference (SPCRuleClashExplanationV1.0.pdf). Each chart renders an Individuals (XmR) SPC chart with variation icons and rule detection enabled. Data points are monthly (ISO YYYY-MM) and values are percentages.

All series map to SPCChart data points via conversion of their ISO month to a Date instance.

## Rule Clash Chart 1 - Trend: a run of 6/7 points or more all consecutively

<div style={{ padding: 12, border: '1px solid #eee', borderRadius: 6, background: '#fafafa' }}>
	<em>Example charts temporarily unavailable while v1 story content is retired. Guidance remains applicable; v2 parity stories demonstrate equivalent scenarios.</em>
</div>

**Commentary**: Gradual increase through mid‑2022 with a local dip at 2022‑09 then recovery. Watch for sustained run above prior mean; confirm shift only after required run length. No hard clash – sequence near but not exceeding classical shift rule length before dip resets count.

## Rule Clash Chart 2 - Shift: a run of 6/7 points or more above or below the mean.

{/* Example embed removed */}

**Commentary**: Mostly stable mid‑5% band with brief deterioration signals around 2022‑11 to 2023‑01. Possible 2-of-3 near limit vs single beyond 3σ if limits tight. Evaluate if downward run length disqualifies an improving shift interpretation.

## Rule Clash Chart 3 - 2/3: where there are 2 out of 3 points outside either the upper or lower control limits.

{/* Example embed removed */}

**Commentary**: Upward shift after early low baseline; later cluster (2023‑02 onwards) may generate both shift and 2-of-3 near limit rules. Precedence: sustained shift classification (improvement) dominates if cluster persists and latest mean relocates.

## Rule Clash Chart 4 - Single point: any single point outside the process limits.

{/* Example embed removed */}

**Commentary**: Early higher values taper, mid-period dip, partial recovery. Possible trend rule (5-point monotonic) vs oscillation around mean causing no sustained shift. Icons likely neutral unless dip breaches inner sigma zones.

## Multiple Rules Example

{/* Example embed removed */}

**Commentary**: Alternating high/low extremes then prolonged high plateau and subsequent decline. Expect multiple rule triggers: early point-beyond-3σ, later run above mean, then potential downward trend. Demonstrates sequencing where later conflicting direction signals appear; narrative should emphasise most recent sustained pattern.

## Precedence & Messaging

When multiple rules trigger at the same most‑recent point, messaging should:

1. Prioritise directionally consistent sustained rules (shift, long run) over single-point outliers.
2. Collapse redundant signals (e.g. both 2-of-3 and 4-of-5 on same side) into the strongest narrative.
3. Surface conflicting direction signals only if overlapping windows are partial and recency differs; emphasise the most recent sustained direction.

| Scenario | Example | Preferred Narrative | Secondary Signals (Suppressed) |
|----------|---------|---------------------|--------------------------------|
| Single high outlier after stable run | Chart 1 | "Special cause improvement (single point beyond 3σ)" | Near-limit run developing |
| Emerging shift + single outlier | Chart 3 | "Shift to higher performance" | Single outlier call-out |
| Multiple alternating extremes | Chart 5 | "Process unstable with alternating special causes" | Individual beyond-limit enumerations |

## Backfill semantics (SQL parity)

The SQL logic evaluates special‑cause rules once the chart qualifies as an SPC chart, and then backfills detected patterns across the full qualifying window/run, including early rows. Our v2 engine now follows this semantics in parity mode.

- Eligibility gating (chart‑level) first
	- A chart is considered eligible once it has at least the minimum number of non‑ghosted points overall (XmR default: 13). When eligible, means/limits exist for all rows in each partition, and rules are evaluated across the full partition, allowing early windows to be coloured.
	- Outside parity mode, a stricter “per‑point” eligibility can be used where limits appear only once each point passes the threshold; this avoids retro‑colouring early rows.

- Single point >3σ
	- Marks that single row only; no backfill beyond the outlier itself.

- Two‑of‑three ≥2σ (same side)
	- When any 3‑point window contains at least two points at or beyond 2σ on the same side of the mean (including ≥3σ), all three rows in that window are marked. Overlapping windows are allowed; later pruning resolves conflicts so only the winning candidate remains per row.

- Shift (6) on one side of the mean
	- Once a contiguous run of eligible points on the same side reaches the threshold, the entire run is backfilled (not just the triggering point). The run resets if a point crosses the mean or at any row where mean/limits are null (gaps, pre‑eligibility).

- Trend (6) strictly increasing/decreasing
	- Analogous to shift: when the strictly monotonic run reaches the threshold, backfill the whole run. Resets at any non‑monotonic step or at rows without mean/limits. Optional cross‑partition trend can be enabled; it still requires eligibility on both sides and never crosses gaps lacking limits.

- Conflict resolution after detection
	- Rules produce candidates which may overlap. A deterministic pruning step applies precedence (including prime direction and rule priorities) so each row ends with at most one icon. Backfilled marks from losing candidates are cleared; rows not in any surviving candidate and within limits are shown as “Neither/Common cause”.

Note: This approach ensures the chart only paints signals from the point in time where there was enough history to detect them. Early points can remain Common Cause even if later a shift/trend emerges.

## Summary

These examples aid design of consistent precedence logic so users see a concise, meaningful summary instead of a confusing cluster of rule labels.
