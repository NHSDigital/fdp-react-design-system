import React from 'react';
import { SPCSpark } from './SPCSpark';
import { Meta } from '@storybook/addon-docs/blocks';

```jsx
// Story args loaded dynamically (avoid direct named import which confused MDX parser)
// @ts-ignore
import * as SparkStories from './SPCSpark.stories';
const { Basic, WithLatestMarker, Dense, ColouredPoints } = SparkStories;
```

<Meta title="Data Visualisation/SPC/SPC Spark/Documentation" name="SPC Spark Guide" />

# SPC Spark

A compact statistical process control (SPC) sparkline summarising recent process behaviour and current variation state.

## Purpose

Provide a glanceable trend with optional: mean, 3-sigma control limits, latest point emphasis, and classification supplied by the SPC engine.

## When To Use

- Dense KPI dashboards where a full SPC chart is too large.
- Table cells summarising a metric's stability.
- Card headers / overview panels.

Avoid using when full interpretive context (signals over time, rules detail) is required—link to a full SPC chart instead.

## Key Props

| Prop | Type | Default | Description |
|------|------|---------|-------------|
| `data` | `Array(value:null|number)` | — | Sequential metric values. `null` creates a gap. |
| `windowSize` | `number` | — | If set, only the trailing N points are rendered (classification still uses shown window). |
| `variationState` | `VariationState` | — | Engine-provided series classification. |
| `showMean` | `boolean` | `true` | Renders horizontal mean dashed line. |
| `showLimits` | `boolean` | `false` | Shows mean ±3σ control limits (requires >=2 numeric points). |
| `showLimitBand` | `boolean` | `false` | Fills the region between ±3σ with a subtle translucent band (requires `showLimits`). |
| `showLatestMarker` | `boolean` | `true` | Enlarges & fills latest valid point. |
| `showStateGlyph` | `boolean` | `true` | Shows H/L glyph when state implies direction and points >= `minPointsForSignals`. |
| `minPointsForSignals` | `number` | `13` | Minimum points before glyph renders (stability gate). |
| `gradientWash` | `boolean` | `false` | Subtle background wash using tokenised opacities. |
| `size` | `'xs' | 'sm' | 'md'` | `sm` | Vertical height preset (width auto based on number of points). |
| `maxPoints` | `number` | — | If set, thin rendered circles to at most this count (path also thinned); classification still uses full window. |
| `thinningStrategy` | `'stride' | 'rdp'` | `'stride'` | `stride` keeps roughly uniform spacing; `rdp` applies a shape-preserving simplification (Ramer–Douglas–Peucker). |
| `colorPointsBySignal` | `boolean` | `false` | When true, each point is coloured individually (improvement / concern / neutral) instead of using a single series colour; latest marker still enlarges. |
| `visualCategories` | `SpcVisualCategory[]` | — | Engine-provided per-point visual categories (Improvement/Concern/NoJudgement/Common). Prefer this over \`pointSignals\` for exact parity with SPCChart. |
| `pointSignals` | Array of string or null | — | Fallback per-point signal labels (allowed values: improvement, concern, neither, or null). Used only when visualCategories isn’t supplied. |
| `pointNeutralSpecialCause` | `boolean[]` | — | Optional flags for per-point “No Judgement” special causes (purple); typically not needed if `visualCategories` is provided. |
{/* sigmaMethod removed in pure-only renderer */}

## Classification Model

SPCSpark is now a pure renderer. Classification and per-point signals come from the SPC engine (see `useSpc` or `SPCChart`). The component does not compute limits or classify locally.

For exact colour parity with `SPCChart`, pass the engine’s visual categories directly via `visualCategories`. When `colorPointsBySignal` is true, SPCSpark will:

- Use `visualCategories` if present to colour points (Improvement → blue, Concern → orange, NoJudgement → purple, Common → grey)
- Otherwise, fall back to `pointSignals` and `pointNeutralSpecialCause`

This mirrors the chart’s visuals layer and prevents subtle drift in edge cases.

### Single-engine parity with SPCChart

For perfect colour and signal parity with `SPCChart`, compute the SPC engine once and share the results:

- Pass `summary.visuals` to the spark via `visualCategories`
- Optionally pass `summary.centerLine`, `summary.controlLimits`, and `summary.sigmaBands` to keep baselines aligned

Use the helper exported from the SPC barrel:

```tsx
import {
	computeSpcPrecomputed,
	ImprovementDirection,
	ChartType,
	DEFAULT_MIN_POINTS,
} from '@nhsdigital/fdp-design-system/components/DataVisualisation/charts/SPC';
import { SPCSpark } from '@nhsdigital/fdp-design-system/components/DataVisualisation/charts/SPC/SPCSpark/SPCSpark';

const values = [12, 11, 10, 9, 8, 7, 20, 22, 21];
const data = values.map((v, i) => ({ x: i, value: v }));

const summary = computeSpcPrecomputed(data, {
	chartType: ChartType.XmR,
	metricImprovement: ImprovementDirection.Down,
	minimumPoints: DEFAULT_MIN_POINTS,
	enableNeutralNoJudgement: true,
});

<SPCSpark
	data={data}
	metricImprovement={ImprovementDirection.Down}
	visualCategories={summary.visuals}
	// Optional extras for consistent baselines
	centerLine={summary.centerLine}
	controlLimits={summary.controlLimits}
	sigmaBands={summary.sigmaBands}
	colorPointsBySignal
/>;
```

Tip: The same `summary` can be passed to `SPCChart` via its `precomputed` prop: `precomputed={{ rows: summary.rows, visuals: summary.visuals }}`.

## Visual Anatomy

1. Trend path (state colour)
2. Mean (grey dashed) – optional
3. Control limits (lighter dashed state colour) – optional
4. Limit band (semi-transparent rect spanning ±3σ) – optional
5. Latest marker (slightly larger circle) – optional (by default all points share the series state colour; with `colorPointsBySignal` each point may differ, latest still +1 radius)
6. Glyph (H/L) – gated & optional; dynamically shifts above/below midline based on trailing cluster to reduce overlap
7. Wash (gradient rect) – optional

## Accessibility

- `role="img"` and an `aria-label` (default: "SPC sparkline").
- Consider providing a surrounding textual summary (e.g., "Stable trend; latest value 120 above mean").
- Future work: include generated aria-description narrative similar to full SPC icons.

## Examples

### With Shaded Limit Band
<SPCSpark data={[{value:60},{value:62},{value:59},{value:61},{value:63},{value:60},{value:61},{value:62},{value:64},{value:63},{value:62},{value:61},{value:60},{value:62},{value:63},{value:61},{value:62},{value:60},{value:61},{value:62}]} showMean showLimits showLimitBand centerLine={61.5} controlLimits={{lower:55, upper:68}} />

## Theming & Tokens

State colours and gradient wash opacities leverage existing SPC icon tokens (`improvement`, `concern`, etc.) and `gradient.stop.*` opacity tokens. Dark / high contrast themes will override these centrally.

## Roadmap

- Multi-rule classification (runs, trends, zones)
- Optional spark stacking (mini multi-metric panel)
- Accessible narrative generation
- Performance benchmark for rendering 100+ sparks
- Visual regression coverage

## Changelog

| Date | Change |
|------|--------|
| 2025-08-31 | Initial component scaffold with mean / latest marker |
| 2025-08-31 | Added gradient wash, limits, glyph gating |
| 2025-08-31 | Removed local auto classification; spark is now a pure renderer using engine-provided values |
| 2025-08-31 | Unified point styling (solid fill, no stroke), padding to prevent clipping, optional render thinning (`maxPoints`, `thinningStrategy`). |
| 2025-08-31 | Added shaded 3σ limit band (`showLimitBand`) and dynamic glyph vertical avoidance logic. |
| 2025-08-31 | Added moving-range sigma option (`sigmaMethod`) for parity with XmR charts. |
| 2025-08-31 | Added per-point signal colouring (`colorPointsBySignal`). Clarified that `showMean` only toggles line visibility (mean still used for limits & classification). |
| 2025-09-21 | Added `visualCategories` prop. Prefer categories over `pointSignals` for parity with SPCChart; updated docs with single-engine parity pattern. |

