@use "../../../packages/nhs-fdp/dist/scss/tokens" as nhs;

// Mermaid diagram base wrapper
.mermaid-diagram {
	--_mm-bg: var(--nhs-fdp-color-grey-6, nhs.$nhs-fdp-color-grey-6);
	--_mm-border: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4);
	--_mm-text: var(--nhs-fdp-color-text, nhs.$nhs-fdp-color-primary-black);
	--_mm-accent: var(
		--nhs-fdp-color-primary-blue,
		nhs.$nhs-fdp-color-primary-blue
	);
	--_mm-accent-alt: var(
		--nhs-fdp-color-data-viz-spc-improvement,
		nhs.$nhs-fdp-color-data-viz-spc-improvement
	);
	--_mm-warn: var(
		--nhs-fdp-color-data-viz-spc-concern,
		nhs.$nhs-fdp-color-data-viz-spc-concern
	);
	--_mm-radius: 6px;
	background: var(--_mm-bg);
	border: 1px solid var(--_mm-border);
	border-radius: var(--_mm-radius);
	padding: nhs.$nhs-fdp-spacing-4; // token spacing
	overflow-x: auto;
	// Use base + fallback font family tokens (no dedicated mono token currently)
	font-family:
		#{nhs.$nhs-fdp-font-family-base},
		#{nhs.$nhs-fdp-font-family-fallback};
	line-height: 1.3;
	position: relative;

	/* Scroll hint (fade) */
	mask-image: linear-gradient(
		to right,
		transparent 0,
		#000 24px,
		#000 calc(100% - 24px),
		transparent 100%
	);
}

.mermaid-error {
	background: var(
		--nhs-fdp-color-data-viz-spc-concern,
		nhs.$nhs-fdp-color-data-viz-spc-concern
	);
	color: #fff;
	padding: nhs.$nhs-fdp-spacing-3;
	border-radius: 4px;
	font-size: 14px;
	overflow-x: auto;
}

/* Core mermaid-generated element overrides */
.mermaid-diagram svg {
	width: 100%;
	height: auto;
}
/* Base node shapes (extra specificity + !important to beat Mermaid injected <style>) */
.mermaid-diagram svg .node rect,
.mermaid-diagram svg .node polygon,
.mermaid-diagram svg .node circle,
.mermaid-diagram svg .node ellipse {
	fill: var(
		--nhs-fdp-color-primary-blue,
		nhs.$nhs-fdp-color-primary-blue
	) !important;
	stroke: var(--_mm-border) !important;
	stroke-width: 1px !important;
	rx: var(--_mm-radius);
	ry: var(--_mm-radius);
}

.mermaid-diagram svg .node text {
	fill: var(--_mm-text) !important;
	font-size: 13px;
	font-family:
		#{nhs.$nhs-fdp-font-family-base},
		#{nhs.$nhs-fdp-font-family-fallback} !important;
}

/* Decision nodes (rhombus) */
.mermaid-diagram .node .label foreignObject > div {
	padding: 2px 4px;
}
/* Mermaid generated structure overrides (hierarchical nesting) */
.mermaid-diagram {
	
	font-family: '#{nhs.$nhs-fdp-font-family-base}', nhs.$nhs-fdp-font-family-fallback;
	
	svg {
		width: 100%;
		height: auto;
	}

	span {
		&.nodeLabel {
			font-size: 14px !important;
			color: var(--nhs-fdp-color-primary-white, nhs.$nhs-fdp-color-primary-white) !important;
			font-family: '#{nhs.$nhs-fdp-font-family-base}', nhs.$nhs-fdp-font-family-fallback;
		}
	}

	/* Nodes */
	svg {
		.node {
			/* Base shapes (specificity via svg .node + !important) */
			rect,
			polygon,
			circle,
			ellipse {
				fill: var(
					--nhs-fdp-color-primary-blue,
					nhs.$nhs-fdp-color-primary-blue
				) !important;

				stroke: var(--_mm-border) !important;
				stroke-width: 1px !important;
				rx: var(--_mm-radius);
				ry: var(--_mm-radius);
			}

			text {
				/* Use standard diagram text colour; 12px matches Mermaid default to avoid bbox truncation */
				fill: var(
					--nhs-fdp-color-primary-white,
					nhs.$nhs-fdp-color-primary-white
				) !important;
				font-size: 12px;
				font-family:
					'#{nhs.$nhs-fdp-font-family-base}',
					#{nhs.$nhs-fdp-font-family-fallback} !important;
			}

			/* Accent nodes (start/end/terminal) */
			&[id^="A"],
			&[id^="Z"],
			&[id^="X"] {
				rect,
				polygon,
				circle,
				ellipse {
					fill: var(--_mm-accent-alt) !important;
					stroke: var(--_mm-accent) !important;
				}
				text {
					font-weight: 600 !important;
				}
			}

			/* Highlight key action outputs */
			&[id^="H"],
			&[id^="N"] {
				rect,
				polygon,
				circle,
				ellipse {
					fill: var(--_mm-accent) !important;
					stroke: var(--_mm-accent-alt) !important;
				}
				text {
					fill: #fff !important;
					font-weight: 600 !important;
				}
			}

			.label {
				foreignObject > div {
					padding: 2px 4px;
				}

				/* Decision emphasis for threshold-related content */
				&:has(div:contains("threshold")),
				&:has(span:contains("threshold")) {
					rect {
						stroke: var(--_mm-warn);
					}
				}
			}
		}

		/* Edges */
		.edgePath {
			path.path {
				stroke: var(--_mm-border) !important;
				stroke-width: 1.2px !important;
			}
		}
		.edgeLabel {
			background-color: nhs.$nhs-fdp-color-primary-white !important; /* optional background */
			margin: 0 4px;
			padding: 0 2px;
			overflow: visible; /* allow expansion */
			font-size: 11px;
			text {
				fill: var(--_mm-text) !important;
				white-space: nowrap;
				font-size: 12px;
				font-weight: bold;
			}
		}
	}
}

/* Dark mode */
.theme-dark {
	.mermaid-diagram {
		--_mm-bg: var(--nhs-fdp-color-grey-1, nhs.$nhs-fdp-color-grey-1);
		--_mm-border: var(--nhs-fdp-color-grey-3, nhs.$nhs-fdp-color-grey-3);
		--_mm-text: var(--nhs-fdp-color-text-on-dark, #fff);
	}
}
