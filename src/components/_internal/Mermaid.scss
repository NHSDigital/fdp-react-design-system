@use "../../../packages/nhs-fdp/scss" as nhs;
@use "./diagram-tokens" as diagram;

// Mermaid diagram base wrapper
.mermaid-diagram {
	--_mm-bg: var(--nhs-fdp-color-grey-6, nhs.$nhs-fdp-color-grey-6);
	--_mm-border: var(--nhs-fdp-color-grey-4, nhs.$nhs-fdp-color-grey-4);
	--_mm-text: var(--nhs-fdp-color-text, nhs.$nhs-fdp-color-primary-black);
	--_mm-accent: var(
		--nhs-fdp-color-primary-blue,
		nhs.$nhs-fdp-color-primary-blue
	);
	--_mm-accent-alt: var(
		--nhs-fdp-color-data-viz-spc-improvement,
		nhs.$nhs-fdp-color-data-viz-spc-improvement
	);
	--_mm-warn: var(
		--nhs-fdp-color-data-viz-spc-concern,
		nhs.$nhs-fdp-color-data-viz-spc-concern
	);
	--_mm-radius: 6px;

	/* Defaults for node padding used by the TS adjuster (in px numbers) */
	--mermaid-node-base-padding-x: 12;
	--mermaid-node-base-padding-y: 8;
	/* Extra padding you can add on top per diagram/context */
	--mermaid-node-extra-padding-x: 0;
	--mermaid-node-extra-padding-y: 0;

	/* Extra padding to apply to the SVG viewBox (in px) to avoid edge clipping */
	--mermaid-svg-extra-padding-x: 20;
	--mermaid-svg-extra-padding-y: 16;

	/* Edge label sizing controls */
	--mermaid-edge-label-padding-x: 4;
	--mermaid-edge-label-padding-y: 2;
	--mermaid-edge-label-bg: #{nhs.$nhs-fdp-color-primary-white};
	background: var(--_mm-bg);
	border: 1px solid var(--_mm-border);
	border-radius: var(--_mm-radius);
	padding: nhs.$nhs-fdp-spacing-4; // token spacing
	overflow-x: auto;
	// Use base + fallback font family tokens (no dedicated mono token currently)
	font-family:
		#{nhs.$nhs-fdp-font-family-base},
		#{nhs.$nhs-fdp-font-family-fallback};
	line-height: 1.3;
	position: relative;

	/* Scroll hint (fade) - removed to prevent edge clipping */
	/* Use overflow-x: auto for horizontal scrolling instead */
}

/* Optional utility variants to quickly tweak padding per-diagram */
.mermaid-diagram.is-compact {
	--mermaid-node-base-padding-x: 8;
	--mermaid-node-base-padding-y: 6;
}

.mermaid-diagram.is-cozy {
	--mermaid-node-base-padding-x: 16;
	--mermaid-node-base-padding-y: 10;
}

.mermaid-diagram.is-spacious {
	--mermaid-node-base-padding-x: 20;
	--mermaid-node-base-padding-y: 14;
}

/* Extra roomy */
.mermaid-diagram.is-airy {
	--mermaid-node-base-padding-x: 24;
	--mermaid-node-base-padding-y: 16;
	--mermaid-svg-extra-padding-x: 32;
	--mermaid-svg-extra-padding-y: 24;
	padding: nhs.$nhs-fdp-spacing-5; // Extra container padding
}

.mermaid-error {
	background: var(
		--nhs-fdp-color-data-viz-spc-concern,
		nhs.$nhs-fdp-color-data-viz-spc-concern
	);
	color: #fff;
	padding: nhs.$nhs-fdp-spacing-3;
	border-radius: 4px;
	font-size: 14px;
	overflow-x: auto;
}

/* (Removed duplicate top-level node/label overrides in favour of the consolidated block below) */
/* Mermaid generated structure overrides (hierarchical nesting) */
.mermaid-diagram {

	span {
		&.nodeLabel {
			font-size: 14px !important;
			color: var(--nhs-fdp-color-primary-white, nhs.$nhs-fdp-color-primary-white) !important;
			font-family: '#{nhs.$nhs-fdp-font-family-base}', nhs.$nhs-fdp-font-family-fallback;
		}
	}

	/* Nodes and edges (single authoritative block) */
	svg {
		width: 100%;
		height: auto;
		.node {
			/* Base shapes (specificity via svg .node + !important) */
			rect,
			polygon,
			circle,
			ellipse {
				fill: var(
					--nhs-fdp-color-primary-blue,
					nhs.$nhs-fdp-color-primary-blue
				) !important;

				stroke: var(--_mm-border) !important;
				stroke-width: 1px !important;
				rx: var(--_mm-radius);
				ry: var(--_mm-radius);
			}

				text {
					/* Keep fill only; allow Mermaid-measured font to define node sizing */
					fill: var(
						--nhs-fdp-color-primary-white,
						nhs.$nhs-fdp-color-primary-white
					) !important;
					/* Avoid overriding font-size/family to prevent bbox mismatch */
					white-space: pre; /* only break on explicit \n */
				}

			/* Accent nodes (start/end/terminal) */
			&[id^="A"],
			&[id^="Z"],
			&[id^="X"] {
				rect,
				polygon,
				circle,
				ellipse {
					fill: var(--_mm-accent-alt) !important;
					stroke: var(--_mm-accent) !important;
				}
				text {
					font-weight: 600 !important;
				}
			}

			/* Highlight key action outputs */
			&[id^="H"],
			&[id^="N"] {
				rect,
				polygon,
				circle,
				ellipse {
					fill: var(--_mm-accent) !important;
					stroke: var(--_mm-accent-alt) !important;
				}
				text {
					fill: #fff !important;
					font-weight: 600 !important;
				}
			}

			.label {
				foreignObject {
					overflow: visible; /* allow expansion */

					div {
						display: contents !important;
					}
				}

				// & > div {
				// 	padding: 2px 4px;
				// 	white-space: normal;
				// 	word-wrap: break-word;
				// }

				/* Decision emphasis for threshold-related content */
				&:has(div:contains("threshold")),
				&:has(span:contains("threshold")) {
					rect {
						stroke: var(--_mm-warn);
					}
				}
			}
		}
		
		.clusters {

			foreignObject {
				overflow: visible !important; /* allow expansion */
				y: nhs.$nhs-fdp-spacing-2 !important; /* slight nudge down */
			}

			span.nodeLabel {
				margin-top: nhs.$nhs-fdp-spacing-1; // 8px
				font-size: 16px !important;
				font-weight: 600 !important;
				fill: var(--nhs-fdp-color-primary-blue, nhs.$nhs-fdp-color-primary-blue) !important;
				color: var(--nhs-fdp-color-primary-blue, nhs.$nhs-fdp-color-primary-blue) !important;
			}
		}
		
		/* Token-driven class styles (no need for Mermaid classDef colours) */
		.node.decision {
			rect, polygon, circle, ellipse {
				fill: #{diagram.$nhs-fdp-diagram-flowchart-decision-fill} !important;
				stroke: #{diagram.$nhs-fdp-diagram-flowchart-decision-stroke} !important;
				color: #{diagram.$nhs-fdp-diagram-flowchart-decision-text} !important;
			}
			text { 
				fill: #{diagram.$nhs-fdp-diagram-flowchart-decision-text} !important; 
			}
			.nodeLabel {
				color: #{diagram.$nhs-fdp-diagram-flowchart-decision-text} !important;
			}
		}

		.node.auto {
			rect, polygon, circle, ellipse {
				fill: #{diagram.$nhs-fdp-diagram-flowchart-auto-fill} !important;
				stroke: #{diagram.$nhs-fdp-diagram-flowchart-auto-stroke} !important;
			}
			text { fill: #{diagram.$nhs-fdp-diagram-flowchart-auto-text} !important; }
			.nodeLabel {
				color: #{diagram.$nhs-fdp-diagram-flowchart-auto-text} !important;
			}
		}

		.node.action {
			rect, polygon, circle, ellipse {
				fill: #{diagram.$nhs-fdp-diagram-flowchart-action-fill} !important;
				stroke: #{diagram.$nhs-fdp-diagram-flowchart-action-stroke} !important;
			}
			text { fill: #{diagram.$nhs-fdp-diagram-flowchart-action-text} !important; }
			.nodeLabel {
				color: #{diagram.$nhs-fdp-diagram-flowchart-action-text} !important;
			}
		}

		.node.warning {
			rect, polygon, circle, ellipse {
				fill: #{diagram.$nhs-fdp-diagram-flowchart-warning-fill} !important;
				stroke: #{diagram.$nhs-fdp-diagram-flowchart-warning-stroke} !important;
			}
			text { fill: #{diagram.$nhs-fdp-diagram-flowchart-warning-text} !important; }
			.nodeLabel {
				color: #{diagram.$nhs-fdp-diagram-flowchart-warning-text} !important;
			}
		}

		/* Lifecycle diagram specific styles */
		.node.lifecycle-start {
			rect, polygon, circle, ellipse {
				fill: #e1f5fe !important; /* Light blue */
				stroke: #01579b !important;
			}
			text { fill: #01579b !important; }

			.nodeLabel {
				color: #01579b !important;
			}
		}

		.node.lifecycle-ready {
			rect, polygon, circle, ellipse {
				fill: #c8e6c9 !important; /* Light green */
				stroke: #1b5e20 !important;
			}
			text { fill: #1b5e20 !important; }

			.nodeLabel {
				color: #1b5e20 !important;
			}
		}

		.node.lifecycle-error {
			
			rect, polygon, circle, ellipse {
				fill: #ffcdd2 !important; /* Light red */
				stroke: #b71c1c !important;
			}
			text { fill: #b71c1c !important; }
			
			.nodeLabel {
				color: #b71c1c !important;
			}
		}

		.node.lifecycle-phase {
			rect, polygon, circle, ellipse {
				fill: #fff9c4 !important; /* Yellow */
				stroke: #f57f17 !important;
			}
			text { fill: #f57f17 !important; }

			.nodeLabel {
				color: #f57f17 !important;
			}
		}

		.node.lifecycle-user-action {
			rect, polygon, circle, ellipse {
				fill: #f8bbd0 !important; /* Pink */
				stroke: #880e4f !important;
			}
			text { fill: #880e4f !important; }

			.nodeLabel {
				color: #880e4f !important;
			}
		}

		.node.lifecycle-complete {
			rect, polygon, circle, ellipse {
				fill: #d1c4e9 !important; /* Light purple */
				stroke: #4a148c !important;
			}
			text { fill: #4a148c !important; }

			.nodeLabel {
				color: #4a148c !important;
			}
		}

		.node.lifecycle-announce {
			rect, polygon, circle, ellipse {
				fill: #b2dfdb !important; /* Light teal */
				stroke: #004d40 !important;
			}
			text { fill: #004d40 !important; }

			.nodeLabel {
				color: #004d40 !important;
			}
		}

		.node.initPhase {
			rect, polygon, circle, ellipse {
				fill: #fff3e0 !important; /* Light orange */
				stroke: #ff6f00 !important;
				stroke-width: 2px !important;
			}
			text { fill: #e65100 !important; }

			.nodeLabel {
				color: #e65100 !important;
			}
		}

		.node.sortPhase {
			rect, polygon, circle, ellipse {
				fill: #e8eaf6 !important; /* Light indigo */
				stroke: #3f51b5 !important;
				stroke-width: 2px !important;
			}
			text { fill: #1a237e !important; }

			.nodeLabel {
				color: #1a237e !important;
			}
		}

		.node.domPhase {
			rect, polygon, circle, ellipse {
				fill: #e0f2f1 !important; /* Light teal */
				stroke: #009688 !important;
				stroke-width: 2px !important;
			}
			text { fill: #004d40 !important; }

			.nodeLabel {
				color: #004d40 !important;
			}
		}

		/* Edges */
		.edgePath {
			path.path {
				stroke: var(--_mm-border) !important;
				stroke-width: 1.2px !important;
			}
		}

		/* Markers (arrowheads) - ensure they render on top and are visible */
		marker {
			overflow: visible !important;
			
			path {
				fill: var(--_mm-border) !important;
				stroke: var(--_mm-border) !important;
			}
		}

		/* Ensure markers render above nodes by adjusting SVG rendering order */
		defs {
			marker {
				/* Markers are defined in defs, ensure they're styled */
				path {
					fill: var(--_mm-border) !important;
					stroke: none !important;
				}
			}
		}

		.edgeLabel {
			background-color: nhs.$nhs-fdp-color-primary-white !important; /* optional background */
			overflow: visible !important; /* allow expansion */
			font-size: 18px;
			text {
				fill: var(--_mm-text) !important;
				white-space: nowrap;
				font-size: 12px;
				font-weight: bold;
			}

			rect {
				background-color: nhs.$nhs-fdp-color-primary-white !important; /* optional background */
				fill: nhs.$nhs-fdp-color-primary-white !important; /* optional background */
			}

			foreignObject {
				overflow: visible !important; /* allow expansion */

				div {
					display: contents !important;
					padding: var(--mermaid-edge-label-padding-y)
						var(--mermaid-edge-label-padding-x);
					background: var(--mermaid-edge-label-bg);
					white-space: normal;
					word-wrap: break-word;
				}
			}
		}
	}
}

/* Dark mode */
.theme-dark {
	.mermaid-diagram {
		--_mm-bg: var(--nhs-fdp-color-grey-1, nhs.$nhs-fdp-color-grey-1);
		--_mm-border: var(--nhs-fdp-color-grey-3, nhs.$nhs-fdp-color-grey-3);
		--_mm-text: var(--nhs-fdp-color-text-on-dark, #fff);
	}
}
